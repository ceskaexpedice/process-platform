<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Dashboard: Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        /* Styly pro stav Workeru */
        .status-running { background-color: #0d6efd; } /* Primary/Running */
        .status-idle { background-color: #198754; }    /* Success/Idle */
        .status-error { background-color: #dc3545; }   /* Danger/Error */
        .log-error { color: #dc3545; font-weight: bold; }
        .log-standard { color: #212529; }
    </style>
</head>
<body>

    <div class="container mt-5">
        <h1 class="mb-4 text-secondary">Provozn칤 Dashboard Workeru</h1>
        <p class="text-muted">P콏istupov치no na: <code id="workerApiUrl">/worker/api</code></p>
        <div id="alertPlaceholder"></div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div id="workerStateCard" class="card text-white mb-3">
                    <div class="card-header">**Aktu치ln칤 Stav Workeru**</div>
                    <div class="card-body">
                        <h2 class="card-title" id="currentState">IDLE</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info mb-3">
                    <div class="card-header">**B캩쮂셖칤 PID** (v OS)</div>
                    <div class="card-body">
                        <h2 class="card-title" id="currentPid">N/A</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-dark mb-3">
                    <div class="card-header">**Posledn칤 Exit K칩d**</div>
                    <div class="card-body">
                        <h2 class="card-title" id="lastExitCode">N/A</h2>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <h2 class="mb-3">丘뙖잺 Detail Aktivn칤 칔lohy</h2>
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Aktivn칤 Proces (<span id="activeProcessId">Nen칤 aktivn칤 proces</span>)</h5>
            </div>
            <div class="card-body" id="currentProcessDetails">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Plugin ID:</strong> <span id="detailPluginId" class="text-muted">...</span></p>
                        <p><strong>Profile ID:</strong> <span id="detailProfileId" class="text-muted">...</span></p>
                        <p><strong>Main Class:</strong> <span id="detailMainClass" class="text-muted">...</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>JVM Argumenty:</strong> <span id="detailJvmArgs" class="text-muted">...</span></p>
                        <p><strong>Batch/Owner:</strong> <span id="detailBatchOwner" class="text-muted">...</span></p>
                    </div>
                </div>
                <h6 class="mt-3">Payload (Vstupn칤 Data)</h6>
                <pre class="bg-light p-2 border" id="detailPayload">Nen칤 k dispozici</pre>

                <button class="btn btn-danger mt-3" id="killProcessBtn" disabled>
                    <i class="fas fa-skull-crossbones"></i> Ukon캜it (Kill) B캩쮂셖칤 Proces
                </button>
                <button class="btn btn-warning mt-3" id="deleteDirBtn" disabled>
                    <i class="fas fa-trash-alt"></i> Smazat Pracovn칤 Adres치콏
                </button>
            </div>
        </div>
        
        <h2 class="mb-3">游닆 Logy B캩쮂셖칤ho Procesu</h2>
        <div class="card shadow">
            <div class="card-header bg-dark text-white d-flex justify-content-between">
                <h5 class="mb-0">콯iv칳 Log (Posledn칤ch 100 콎치dk콢)</h5>
                <div class="btn-group" role="group">
                    <button id="showOutLogBtn" class="btn btn-sm btn-light">Standard OUT</button>
                    <button id="showErrLogBtn" class="btn btn-sm btn-outline-light">Error ERR</button>
                    <button id="downloadLogBtn" class="btn btn-sm btn-outline-light">St치hnout Log</button>
                </div>
            </div>
            <pre id="logArea" class="card-body bg-light" style="max-height: 400px; overflow-y: scroll; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;">캛ek치m na spu코t캩n칤 procesu a na캜칤t치n칤 log콢...</pre>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API cesta pro Worker, odvozen치 z docker run WORKER_BASE_URL=.../worker/api/
        const WORKER_API_BASE_PATH = '/worker/api/manager'; 
        const LOG_LIMIT = 100;
        let lastLogOffset = 0;
        let currentProcessId = null;
        let logType = 'out'; // 'out' nebo 'err'

        function getStatusColor(state) {
            if (state === 'RUNNING') return 'bg-primary';
            if (state === 'IDLE') return 'bg-success';
            if (state === 'ERROR' || state === 'FAILED') return 'bg-danger';
            return 'bg-secondary';
        }

        async function fetchWorkerInfo() {
            try {
                // Vol치 nap콏. http://192.168.88.252:8081/worker/api/info
                const response = await fetch(`${WORKER_API_BASE_PATH}/info`);
                if (!response.ok) throw new Error(`HTTP chyba! Stav: ${response.status}`);
                
                const data = await response.json(); 
                
                updateDashboard(data);
                
                // Spust칤 na캜칤t치n칤 log콢, pokud se zm캩nil proces
                if (data.currentProcess && data.currentProcess.processId !== currentProcessId) {
                    currentProcessId = data.currentProcess.processId;
                    lastLogOffset = 0;
                    document.getElementById('logArea').textContent = 'Na캜칤t치m nov칳 log...';
                }
                
                // Povol칤 maz치n칤 adres치콏e, pokud u proces dob캩hl (currentProcess je null)
                document.getElementById('deleteDirBtn').disabled = !!data.currentProcess;
                
                if (currentProcessId) {
                    fetchProcessLogs(currentProcessId);
                }

            } catch (error) {
                console.error("Chyba p콏i na캜칤t치n칤 dat Workeru:", error);
                document.getElementById('currentState').textContent = 'OFFLINE/CHYBA';
                document.getElementById('workerStateCard').className = 'card text-white bg-danger mb-3';
                document.getElementById('currentPid').textContent = 'N/A';
                currentProcessId = null;
            }
        }

        function updateDashboard(data) {
            // 1. Info Cards
            const card = document.getElementById('workerStateCard');
            card.className = `card text-white ${getStatusColor(data.state)} mb-3`;
            document.getElementById('currentState').textContent = data.state;
            document.getElementById('currentPid').textContent = data.currentPid || 'N/A';
            document.getElementById('lastExitCode').textContent = data.lastExitCode !== null ? data.lastExitCode : 'N/A';
            document.getElementById('workerApiUrl').textContent = `${window.location.protocol}//${window.location.host}${WORKER_API_BASE_PATH}`;

            // 2. Detail Procesu
            const details = document.getElementById('currentProcessDetails');
            const process = data.currentProcess;
            
            // Aktivuje/Deaktivuje ak캜n칤 tla캜칤tka
            document.getElementById('killProcessBtn').disabled = !data.currentPid;
            
            if (process) {
                currentProcessId = process.processId;
                document.getElementById('activeProcessId').textContent = currentProcessId;
                document.getElementById('detailPluginId').textContent = process.pluginId || 'N/A';
                document.getElementById('detailProfileId').textContent = process.profileId || 'N/A';
                document.getElementById('detailMainClass').textContent = process.mainClass || 'N/A';
                document.getElementById('detailJvmArgs').textContent = process.jvmArgs ? process.jvmArgs.join(', ') : '콯치dn칠';
                document.getElementById('detailBatchOwner').textContent = `${process.batchId || 'N/A'} / ${process.ownerId || 'N/A'}`;
                
                try {
                    document.getElementById('detailPayload').textContent = JSON.stringify(process.payload || {}, null, 2);
                } catch (e) {
                    document.getElementById('detailPayload').textContent = 'Chyba p콏i parsov치n칤 Payloadu';
                }
                
            } else {
                currentProcessId = null;
                document.getElementById('activeProcessId').textContent = 'Nen칤 aktivn칤 proces';
                details.querySelectorAll('span.text-muted').forEach(span => span.textContent = '...');
                document.getElementById('detailPayload').textContent = 'Nen칤 k dispozici';
            }
        }

        async function fetchProcessLogs(processId) {
            // Vol치 nap콏. /worker/api/ed25ce29-2149-439d-85c4-cc5e516e3036/log/out/lines
            const endpoint = `${WORKER_API_BASE_PATH}/${processId}/log/${logType}/lines?offset=${lastLogOffset}&limit=${LOG_LIMIT}`;
            
            try {
                const response = await fetch(endpoint);
                if (response.status === 404) {
                    document.getElementById('logArea').textContent = `Logy (${logType.toUpperCase()}) pro proces ${processId} nebyly nalezeny (404).`;
                    return;
                }
                if (!response.ok) throw new Error(`Chyba p콏i na캜칤t치n칤 log콢: ${response.status}`);
                
                const newLines = await response.json(); 
                const logArea = document.getElementById('logArea');
                
                if (newLines && newLines.length > 0) {
                    // P콏id치n칤 nov칳ch 콏치dk콢
                    const formattedLines = newLines.map(line => {
                        // Z치kladn칤 zv칳razn캩n칤 chyb
                        if (line.toUpperCase().includes('ERROR') || line.toUpperCase().includes('EXCEPTION')) {
                            return `<span class="log-error">${line}</span>`;
                        }
                        return line; // Ponech치me jako string, innerHTML se postar치 o <pre>
                    }).join('\n');
                    
                    if (lastLogOffset === 0) {
                        logArea.innerHTML = formattedLines;
                    } else {
                        // P콏id치 odd캩lova캜, pokud p콏id치v치me nov칠 콏치dky po prvn칤m na캜ten칤
                        logArea.innerHTML += '\n' + formattedLines;
                    }
                    
                    lastLogOffset += newLines.length;
                    // Skroluje dol콢
                    logArea.scrollTop = logArea.scrollHeight;
                } else if (lastLogOffset === 0) {
                    logArea.textContent = `Proces b캩쮂, ale log ${logType.toUpperCase()} je zat칤m pr치zdn칳.`;
                }

            } catch (error) {
                console.error("Chyba p콏i na캜칤t치n칤 log콢:", error);
                if (lastLogOffset === 0) {
                     document.getElementById('logArea').textContent = `CHYBA P콎I NA캛칈T츼N칈 LOG콡: ${error.message}`;
                }
            }
        }
        
        // --- Akce ---

        // KILL Process
        document.getElementById('killProcessBtn').addEventListener('click', async () => {
            const pId = currentProcessId;
            if (!pId) return;

            if (confirm(`Opravdu chcete KILL proces ${pId}? Tato akce je nevratn치.`)) {
                try {
                    // Vol치 nap콏. /worker/api/{processId}/kill
                    const response = await fetch(`${WORKER_API_BASE_PATH}/${pId}/kill`, { method: 'DELETE' });
                    if (response.ok) {
                        alert(`Proces ${pId} byl 칰sp캩코n캩 ukon캜en (posl치n sign치l KILL).`);
                        fetchWorkerInfo(); // Aktualizace
                    } else {
                        const errorBody = await response.text();
                        alert(`Chyba p콏i ukon캜ov치n칤 procesu ${pId}. Status: ${response.status}. Detaily: ${errorBody}`);
                    }
                } catch (e) {
                    alert('Chyba komunikace s Workerem. Zkontrolujte spojen칤.');
                }
            }
        });
        
        // Delete Directory
        document.getElementById('deleteDirBtn').addEventListener('click', async () => {
            // Pou쬴jeme ID posledn칤ho procesu, se kter칳m jsme pracovali (i kdy u nen칤 aktivn칤)
            const pId = currentProcessId; 
            
            if (!pId) {
                alert('Nen칤 zn치mo ID procesu pro smaz치n칤 adres치콏e. Adres치콏 se d치 mazat a po dokon캜en칤 칰lohy.');
                return;
            }

            if (confirm(`Opravdu chcete smazat pracovn칤 adres치콏 pro proces ${pId}? (Tato akce by m캩la b칳t prov치d캩na pouze po dokon캜en칤/chyb캩 procesu)`)) {
                 try {
                    // Vol치 nap콏. /worker/api/{processId}/directory
                    const response = await fetch(`${WORKER_API_BASE_PATH}/${pId}/directory`, { method: 'DELETE' });
                    if (response.ok) {
                        alert(`Adres치콏 pro proces ${pId} byl smaz치n.`);
                        // Zde by bylo dobr칠 resetovat ID, pokud to Worker API nezvl치d치 automaticky
                        currentProcessId = null;
                        document.getElementById('activeProcessId').textContent = 'Adres치콏 smaz치n.';
                    } else {
                        const errorBody = await response.text();
                        alert(`Chyba p콏i maz치n칤 adres치콏e. Zkuste zkontrolovat stav Workeru. Detaily: ${errorBody}`);
                    }
                } catch (e) {
                    alert('Chyba komunikace s Workerem. Zkontrolujte spojen칤.');
                }
            }
        });
        
        // P콏ep칤n치n칤 log콢
        document.getElementById('showOutLogBtn').addEventListener('click', () => {
            logType = 'out';
            lastLogOffset = 0;
            document.getElementById('logArea').textContent = 'Na캜칤t치m standardn칤 v칳stup...';
            document.getElementById('showOutLogBtn').className = 'btn btn-sm btn-light';
            document.getElementById('showErrLogBtn').className = 'btn btn-sm btn-outline-light';
            if (currentProcessId) fetchProcessLogs(currentProcessId);
        });

        document.getElementById('showErrLogBtn').addEventListener('click', () => {
            logType = 'err';
            lastLogOffset = 0;
            document.getElementById('logArea').textContent = 'Na캜칤t치m chybov칳 v칳stup...';
            document.getElementById('showOutLogBtn').className = 'btn btn-sm btn-outline-light';
            document.getElementById('showErrLogBtn').className = 'btn btn-sm btn-light';
            if (currentProcessId) fetchProcessLogs(currentProcessId);
        });
        
        // St치hnout log (pou쮂셨치 koncov칠 body pro bin치rn칤 sta쬰n칤)
        document.getElementById('downloadLogBtn').addEventListener('click', () => {
            if (currentProcessId) {
                // Vol치 nap콏. /worker/api/{processId}/log/out
                window.open(`${WORKER_API_BASE_PATH}/${currentProcessId}/log/${logType}`, '_blank');
            } else {
                alert('Nen칤 k dispozici 쮂멳n칠 ID procesu pro sta쬰n칤 logu.');
            }
        });


        // Spu코t캩n칤 inicializace a pravideln칠ho Pollingu
        fetchWorkerInfo(); // Prvn칤 na캜ten칤
        setInterval(fetchWorkerInfo, 3000); // Aktualizace ka쬯칠 3 sekundy
    </script>
</body>
</html>