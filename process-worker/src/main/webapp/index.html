<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Dashboard: Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }

        /* Worker status styles */
        .status-running { background-color: #0d6efd; }
        .status-idle { background-color: #198754; }
        .status-error { background-color: #dc3545; }

        .log-error { color: #dc3545; font-weight: bold; }
        .log-standard { color: #212529; }
    </style>
</head>
<body>

<div class="container mt-5">
    <h1 class="mb-4 text-secondary">Worker Operational Dashboard</h1>
    <p class="text-muted">
        Accessed at: <code id="workerApiUrl">/worker/api</code>
    </p>

    <div id="alertPlaceholder"></div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div id="workerStateCard" class="card text-white mb-3">
                <div class="card-header"><strong>Current Worker State</strong></div>
                <div class="card-body">
                    <h2 class="card-title" id="currentState">IDLE</h2>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-header"><strong>Running PID</strong> (OS)</div>
                <div class="card-body">
                    <h2 class="card-title" id="currentPid">N/A</h2>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-white bg-dark mb-3">
                <div class="card-header"><strong>Last Exit Code</strong></div>
                <div class="card-body">
                    <h2 class="card-title" id="lastExitCode">N/A</h2>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <h2 class="mb-3">‚öôÔ∏è Active Task Details</h2>
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                Active Process (<span id="activeProcessId">No active process</span>)
            </h5>
        </div>

        <div class="card-body" id="currentProcessDetails">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Plugin ID:</strong> <span id="detailPluginId" class="text-muted">...</span></p>
                    <p><strong>Profile ID:</strong> <span id="detailProfileId" class="text-muted">...</span></p>
                    <p><strong>Main Class:</strong> <span id="detailMainClass" class="text-muted">...</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>JVM Arguments:</strong> <span id="detailJvmArgs" class="text-muted">...</span></p>
                    <p><strong>Batch / Owner:</strong> <span id="detailBatchOwner" class="text-muted">...</span></p>
                </div>
            </div>

            <h6 class="mt-3">Payload (Input Data)</h6>
            <pre class="bg-light p-2 border" id="detailPayload">Not available</pre>

            <button class="btn btn-danger mt-3" id="killProcessBtn" disabled>
                <i class="fas fa-skull-crossbones"></i> Kill Running Process
            </button>

            <button class="btn btn-warning mt-3" id="deleteDirBtn" disabled>
                <i class="fas fa-trash-alt"></i> Delete Working Directory
            </button>
        </div>
    </div>

    <h2 class="mb-3">üìú Process Logs</h2>
    <div class="card shadow">
        <div class="card-header bg-dark text-white d-flex justify-content-between">
            <h5 class="mb-0">Live Log (Last 100 Lines)</h5>
            <div class="btn-group">
                <button id="showOutLogBtn" class="btn btn-sm btn-light">Standard OUT</button>
                <button id="showErrLogBtn" class="btn btn-sm btn-outline-light">Error ERR</button>
                <button id="downloadLogBtn" class="btn btn-sm btn-outline-light">Download Log</button>
            </div>
        </div>

        <pre id="logArea"
             class="card-body bg-light"
             style="max-height: 400px; overflow-y: scroll; font-size: 0.85rem; white-space: pre-wrap;">
Waiting for process start and logs...
        </pre>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Worker API base path (derived from WORKER_BASE_URL)
    const WORKER_API_BASE_PATH = '/worker/api/manager';
    const LOG_LIMIT = 100;

    let lastLogOffset = 0;
    let currentProcessId = null;
    let logType = 'out'; // 'out' or 'err'

    function getStatusColor(state) {
        if (state === 'RUNNING') return 'bg-primary';
        if (state === 'IDLE') return 'bg-success';
        if (state === 'ERROR' || state === 'FAILED') return 'bg-danger';
        return 'bg-secondary';
    }

    async function fetchWorkerInfo() {
        try {
            const response = await fetch(`${WORKER_API_BASE_PATH}/info`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

            const data = await response.json();
            updateDashboard(data);

            if (data.currentProcess && data.currentProcess.processId !== currentProcessId) {
                currentProcessId = data.currentProcess.processId;
                lastLogOffset = 0;
                document.getElementById('logArea').textContent = 'Loading new log...';
            }

            document.getElementById('deleteDirBtn').disabled = !!data.currentProcess;

            if (currentProcessId) {
                fetchProcessLogs(currentProcessId);
            }

        } catch (error) {
            document.getElementById('currentState').textContent = 'OFFLINE / ERROR';
            document.getElementById('workerStateCard').className =
                'card text-white bg-danger mb-3';
            document.getElementById('currentPid').textContent = 'N/A';
            currentProcessId = null;
        }
    }

    function updateDashboard(data) {
        const card = document.getElementById('workerStateCard');
        card.className = `card text-white ${getStatusColor(data.state)} mb-3`;

        document.getElementById('currentState').textContent = data.state;
        document.getElementById('currentPid').textContent = data.currentPid || 'N/A';
        document.getElementById('lastExitCode').textContent =
            data.lastExitCode !== null ? data.lastExitCode : 'N/A';

        document.getElementById('workerApiUrl').textContent =
            `${window.location.protocol}//${window.location.host}${WORKER_API_BASE_PATH}`;

        document.getElementById('killProcessBtn').disabled = !data.currentPid;

        const process = data.currentProcess;
        if (process) {
            currentProcessId = process.processId;
            document.getElementById('activeProcessId').textContent = currentProcessId;
            document.getElementById('detailPluginId').textContent = process.pluginId || 'N/A';
            document.getElementById('detailProfileId').textContent = process.profileId || 'N/A';
            document.getElementById('detailMainClass').textContent = process.mainClass || 'N/A';
            document.getElementById('detailJvmArgs').textContent =
                process.jvmArgs ? process.jvmArgs.join(', ') : 'None';
            document.getElementById('detailBatchOwner').textContent =
                `${process.batchId || 'N/A'} / ${process.ownerId || 'N/A'}`;

            document.getElementById('detailPayload').textContent =
                JSON.stringify(process.payload || {}, null, 2);
        } else {
            currentProcessId = null;
            document.getElementById('activeProcessId').textContent = 'No active process';
            document.getElementById('detailPayload').textContent = 'Not available';
        }
    }

    async function fetchProcessLogs(processId) {
        const endpoint =
            `${WORKER_API_BASE_PATH}/${processId}/log/${logType}/lines?offset=${lastLogOffset}&limit=${LOG_LIMIT}`;

        try {
            const response = await fetch(endpoint);
            if (response.status === 404) {
                document.getElementById('logArea').textContent =
                    `Logs (${logType.toUpperCase()}) for process ${processId} not found (404).`;
                return;
            }
            if (!response.ok) throw new Error(`Failed to load logs: ${response.status}`);

            const lines = await response.json();
            const logArea = document.getElementById('logArea');

            if (lines.length > 0) {
                const formatted = lines.map(line =>
                    line.toUpperCase().includes('ERROR') ||
                    line.toUpperCase().includes('EXCEPTION')
                        ? `<span class="log-error">${line}</span>`
                        : line
                ).join('\n');

                logArea.innerHTML += (lastLogOffset ? '\n' : '') + formatted;
                lastLogOffset += lines.length;
                logArea.scrollTop = logArea.scrollHeight;
            }

        } catch (error) {
            if (lastLogOffset === 0) {
                document.getElementById('logArea').textContent =
                    `ERROR LOADING LOGS: ${error.message}`;
            }
        }
    }

    // Initial load and polling
    fetchWorkerInfo();
    setInterval(fetchWorkerInfo, 3000);
</script>
</body>
</html>
