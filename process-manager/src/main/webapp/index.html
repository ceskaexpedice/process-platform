<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Manager Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .status-running { color: #0d6efd; }
        .status-planned { color: #ffc107; }
        .status-finished { color: #198754; }
        .status-error { color: #dc3545; }
        /* Styly pro tabulku Worker콢 */
        .worker-tag {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h1 class="mb-4 text-primary">Process Manager Overview</h1>
    <div id="alertPlaceholder"></div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Celkem Worker콢</div>
                <div class="card-body">
                    <h2 class="card-title" id="workerCount">...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Pr치ce ve Front캩 (PLANNED)</div>
                <div class="card-body">
                    <h2 class="card-title" id="queuedWorkCount">...</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">Aktivn칤 Procesy (RUNNING)</div>
                <div class="card-body">
                    <h2 class="card-title" id="runningProcessCount">...</h2>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <h2>游농 Registrovan칠 Worker Nody</h2>

    <div class="card shadow mb-5">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Seznam Worker N칩d콢 (Typ: WORKER)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>ID Workeru</th>
                        <th>URL API</th>
                        <th>Popis</th>
                        <th>Podporovan칠 Profily (Tagy)</th>
                        <th>Akce</th>
                    </tr>
                    </thead>
                    <tbody id="workerTableBody">
                    <tr><td colspan="5" class="text-center">Na캜칤t치m data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <hr>

    <h2>丘뙖잺 Aktivn칤 Procesy</h2>

    <div class="card shadow">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Aktivn칤 a Pl치novan칠 Procesy (Posledn칤ch 50 d치vek)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>Stav</th>
                        <th>ID Procesu</th>
                        <th>Worker ID</th>
                        <th>Profil</th>
                        <th>Vlastn칤k</th>
                        <th>Popis</th>
                    </tr>
                    </thead>
                    <tbody id="processesTableBody">
                    <tr><td colspan="6" class="text-center">Na캜칤t치m data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="workerInfoModal" tabindex="-1" aria-labelledby="workerInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="workerInfoModalLabel">Informace o Workeru: <span id="infoWorkerId"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="workerInfoContent">Na캜칤t치m informace...</pre>
            </div>
            <div class="modal-footer">
                <div id="modalActions" class="me-auto">
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zav콏칤t</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE_URL = '/process-manager/api';

    function showAlert(message, type = 'danger') {
        const alertPlaceholder = document.getElementById('alertPlaceholder');
        const wrapper = document.createElement('div');
        wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
            `   <div>${message}</div>`,
            '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
            '</div>'
        ].join('');
        alertPlaceholder.prepend(wrapper);
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(wrapper.querySelector('.alert'));
            if(alert) alert.close();
        }, 5000);
    }

    /**
     * Z칤sk치 celkov칳 po캜et Worker nod콢 a z치rove켿 je vyp칤코e.
     */
    async function fetchWorkers() {
        const workerTableBody = document.getElementById('workerTableBody');
        workerTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Na캜칤t치m data...</td></tr>';

        try {
            const response = await fetch(`${API_BASE_URL}/node`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const nodes = await response.json();

            const workerNodes = nodes.filter(node => node.type === 'WORKER');
            document.getElementById('workerCount').textContent = workerNodes.length;

            workerTableBody.innerHTML = '';

            if (workerNodes.length === 0) {
                workerTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenalezeni 쮂멳n칤 registrovan칤 Worke콏i.</td></tr>';
                return;
            }

            workerNodes.forEach(worker => {

                const sortedTags = [...worker.tags];
                sortedTags.sort();

                const tagsHtml = sortedTags.map(tag =>
                    `<span class="badge bg-secondary worker-tag">${tag}</span>`
                ).join('');

                const row = workerTableBody.insertRow();
                row.innerHTML = `
                        <td><strong>${worker.nodeId}</strong></td>
                        <td><small>${worker.url}</small></td>
                        <td>${worker.description || '-'}</td>
                        <td>${tagsHtml || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info text-white" onclick="showWorkerInfo('${worker.nodeId}')" title="Zobrazit aktu치ln칤 stav">
                                <i class="bi bi-info-circle-fill"></i> Stav
                            </button>
                        </td>
                    `;
            });

        } catch (error) {
            console.error("Chyba p콏i na캜칤t치n칤 Worker콢:", error);
            document.getElementById('workerCount').textContent = 'N/A';
            workerTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Chyba p콏i na캜칤t치n칤 dat o Workerech: ${error.message}</td></tr>`;
            showAlert(`Nepoda콏ilo se na캜칤st seznam Worker콢. Chyba: ${error.message}`);
        }
    }

    /**
     * Z칤sk치 aktu치ln칤 informace o workeru a zobraz칤 je v modalu.
     * V p콏칤pad캩 chyby zobraz칤 tla캜칤tko pro deregistraci.
     * @param {string} nodeId ID workeru.
     */
    async function showWorkerInfo(nodeId) {
        const modal = new bootstrap.Modal(document.getElementById('workerInfoModal'));
        const workerInfoContent = document.getElementById('workerInfoContent');
        const infoWorkerId = document.getElementById('infoWorkerId');
        const modalActions = document.getElementById('modalActions');

        infoWorkerId.textContent = nodeId;
        workerInfoContent.textContent = 'Na캜칤t치m informace...';
        modalActions.innerHTML = ''; // Vy캜istit akce
        modal.show();

        try {
            const response = await fetch(`${API_BASE_URL}/node/${nodeId}/info`);
            let errorOccurred = false;

            if (response.status === 404) {
                const errorMessage = `Worker s ID '${nodeId}' nebyl nalezen (404). Je pravd캩podobn캩 off-line nebo byl smaz치n.`;
                workerInfoContent.textContent = errorMessage;
                errorOccurred = true;
            }

            if (!response.ok && response.status !== 404) {
                const errorMessage = `HTTP chyba! Status: ${response.status}. Worker pravd캩podobn캩 neodpov칤d치.`;
                workerInfoContent.textContent = errorMessage;
                errorOccurred = true;
                // Nen칤 pot콏eba throw, chybu zpracujeme n칤쬰
            }

            if (errorOccurred) {
                // P콏id치n칤 tla캜칤tka Deregistrace v p콏칤pad캩 chyby
                modalActions.innerHTML = `
                        <button class="btn btn-danger" onclick="deregisterNode('${nodeId}')">
                            <i class="bi bi-x-octagon-fill"></i> Deregistrovat N칩d
                        </button>
                    `;
            } else {
                const info = await response.json();
                // P캩kn칠 form치tov치n칤 JSONu pro zobrazen칤
                workerInfoContent.textContent = JSON.stringify(info, null, 2);
            }

        } catch (error) {
            console.error(`Chyba s칤t캩/API p콏i na캜칤t치n칤 info pro worker ${nodeId}:`, error);
            workerInfoContent.textContent = `Chyba s칤t캩/API: Nepoda콏ilo se p콏ipojit k ${nodeId}. ${error.message}`;

            // P콏id치n칤 tla캜칤tka Deregistrace v p콏칤pad캩 chyby s칤t캩/fetch
            modalActions.innerHTML = `
                    <button class="btn btn-danger" onclick="deregisterNode('${nodeId}')">
                        <i class="bi bi-x-octagon-fill"></i> Deregistrovat N칩d
                    </button>
                `;
            showAlert(`Chyba: Nepoda콏ilo se z칤skat info pro worker ${nodeId}.`, 'warning');
        }
    }

    /**
     * Provede deregistraci Worker Nodu vol치n칤m nov칠ho endpointu DELETE /worker/unregister_node/{workerId}.
     * @param {string} nodeId ID workeru, kter칳 m치 b칳t deregistrov치n.
     */
    async function deregisterNode(nodeId) {
        if (!confirm(`Opravdu chcete deregistrovat Worker N칩d s ID: ${nodeId}? Tato akce jej odstran칤 ze seznamu registrovan칳ch worker콢.`)) {
            return;
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById('workerInfoModal'));
        if (modal) modal.hide(); // Skr칳t modal, abychom uk치zali alert na hlavn칤 str치nce

        try {
            const endpoint = `${API_BASE_URL}/worker/unregister_node/${nodeId}`;

            const response = await fetch(endpoint, {
                method: 'DELETE'
            });

            if (!response.ok) {
                let errorDetails = response.statusText;
                try {
                    const jsonResponse = await response.json();
                    if (jsonResponse.message) {
                        errorDetails = jsonResponse.message;
                    }
                } catch (e) {
                    // Ignorovat, pokud odpov캩캞 nen칤 JSON
                }
                throw new Error(`HTTP error! Status: ${response.status}. Detaily: ${errorDetails}`);
            }

            const result = await response.json();

            showAlert(`Worker N칩d ${nodeId} byl 칰sp캩코n캩 deregistrov치n. Zpr치va: ${result.message || 'OK'}`, 'success');

        } catch (error) {
            console.error("Chyba p콏i deregistraci workeru:", error);
            showAlert(`Deregistrace Workeru ${nodeId} selhala. Chyba: ${error.message}`, 'danger');
        } finally {
            // Vynutit okam쬴tou aktualizaci tabulky
            setTimeout(() => {
                fetchWorkers();
                fetchProcesses();
            }, 1000);
        }
    }


    /**
     * Z칤sk치 p콏ehled proces콢 (RUNNING, PLANNED) a napln칤 tabulku.
     */
    async function fetchProcesses() {
        const tableBody = document.getElementById('processesTableBody');
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Na캜칤t치m data...</td></tr>';

        let runningCount = 0;
        let plannedCount = 0;

        try {
            const response = await fetch(`${API_BASE_URL}/process/batch?limit=50`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            tableBody.innerHTML = ''; // Vy캜ist칤me tabulku

            let allProcesses = [];
            data.batches.forEach(batch => {
                batch.processes.forEach(process => {
                    // P콏id치me proces do seznamu, pokud m치 stav, kter칳 n치s zaj칤m치 (RUNNING, PLANNED)
                    if (process.status === 'RUNNING' || process.status === 'PLANNED') {
                        allProcesses.push(process);
                    }
                });
            });

            allProcesses.sort((a, b) => {
                if (a.status === 'RUNNING' && b.status !== 'RUNNING') return -1;
                if (a.status !== 'RUNNING' && b.status === 'RUNNING') return 1;
                return 0;
            });

            if (allProcesses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">콯치dn칠 aktivn칤 nebo pl치novan칠 procesy k zobrazen칤.</td></tr>';
            }

            allProcesses.forEach(process => {

                if (process.status === 'RUNNING') runningCount++;
                if (process.status === 'PLANNED') plannedCount++;

                const row = tableBody.insertRow();

                row.innerHTML = `
                        <td><span class="badge rounded-pill ${getBadgeClass(process.status)}">${process.status || 'N/A'}</span></td>
                        <td><code title="${process.processId}">${process.processId.substring(0, 8)}...</code></td>
                        <td>${process.workerId || 'Nen칤 p콏i콏azen'}</td>
                        <td>${process.profileId || 'N/A'}</td>
                        <td>${process.owner || 'N/A'}</td>
                        <td>${process.description || '-'}</td>
                    `;
            });

            document.getElementById('runningProcessCount').textContent = runningCount;
            document.getElementById('queuedWorkCount').textContent = plannedCount;

        } catch (error) {
            console.error("Chyba p콏i na캜칤t치n칤 proces콢:", error);
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Chyba p콏i na캜칤t치n칤 dat o procesech: ${error.message}</td></tr>`;
            document.getElementById('runningProcessCount').textContent = 'N/A';
            document.getElementById('queuedWorkCount').textContent = 'N/A';
            showAlert(`Nepoda콏ilo se na캜칤st seznam Proces콢. Chyba: ${error.message}`);
        }
    }

    function getBadgeClass(status) {
        switch (status) {
            case 'RUNNING': return 'bg-primary';
            case 'PLANNED': return 'bg-warning text-dark';
            case 'FINISHED': return 'bg-success';
            case 'ERROR': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    /**
     * Inicializace dashboardu - spust칤 na캜칤t치n칤 dat a nastav칤 interval.
     */
    function initDashboard() {
        fetchWorkers();
        fetchProcesses();

        // Periodick치 aktualizace ka쬯칳ch 5 sekund
        setInterval(() => {
            fetchWorkers();
            fetchProcesses();
        }, 5000);
    }

    // Spu코t캩n칤 po na캜ten칤 DOM
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>

</body>
</html>